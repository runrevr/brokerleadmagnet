<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brokerage Intelligence Assessment Platform</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Manrope:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'spruce': '#264E36',
                        'river-stone': '#78909C',
                        'sea-glass': '#9DBFBF',
                        'mist': '#F5F7F7',
                        'storm-gray': '#37474F',
                        'fern': '#607D3B',
                        'bark-brown': '#6F4E37',
                        'signal-red': '#CC0000',
                        'amber': '#F59E0B'
                    },
                    fontFamily: {
                        'bebas': ['Bebas Neue', 'sans-serif'],
                        'manrope': ['Manrope', 'sans-serif'],
                        'jetbrains': ['JetBrains Mono', 'monospace']
                    }
                }
            }
        }
    </script>
    <style>
        /* Print-specific styles for PDF generation */
        @media print {
            /* Hide elements that shouldn't appear in PDF */
            .no-print {
                display: none !important;
            }

            /* Reset backgrounds for printing */
            body {
                background: white !important;
            }

            /* Remove shadows for cleaner print */
            .shadow-lg, .shadow, .shadow-sm {
                box-shadow: none !important;
            }

            /* Ensure charts render properly */
            canvas {
                max-width: 100%;
                page-break-inside: avoid;
            }

            /* Page breaks */
            .print-break {
                page-break-before: always;
            }

            .print-avoid-break {
                page-break-inside: avoid;
            }

            /* Adjust margins for print */
            @page {
                margin: 0.5in;
            }

            /* Ensure colored backgrounds print */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        /* Base typography */
        body {
            font-family: 'Manrope', sans-serif;
        }

        h1, h2 {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.02em;
        }

        h3, h4, h5 {
            font-family: 'Manrope', sans-serif;
        }

        .font-mono, .score-display {
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Transaction Failure Risk Assessment Questions
        // New Philosophy: Every question should either:
        // - Quantify actual losses happening RIGHT NOW
        // - Expose a blind spot they didn't know they had
        // - Make them realize "oh shit, we can't actually do that"
        const assessmentQuestions = {
            companyInfo: {
                title: "Company Profile",
                questions: [
                    {
                        id: "company_name",
                        label: "Brokerage Name",
                        type: "text",
                        required: true
                    },
                    {
                        id: "agent_count",
                        label: "Number of Agents",
                        type: "select",
                        options: ["1-10", "11-25", "26-50", "51-100", "100+"],
                        required: true
                    },
                    {
                        id: "monthly_deals",
                        label: "Average Monthly Transactions",
                        type: "select",
                        options: ["1-10", "11-20", "21-50", "51-100", "101-200", "200+"],
                        required: true
                    },
                    {
                        id: "location",
                        label: "Primary Market/City",
                        type: "text",
                        required: true
                    },
                    {
                        id: "transaction_system",
                        label: "What transaction management system do you use?",
                        type: "select",
                        options: ["SkySlope", "LoneWolf", "Dotloop", "Other", "None"],
                        required: true
                    }
                ]
            },
            dealFailureReality: {
                title: "Deal Failure Reality",
                questions: [
                    {
                        id: "deals_fallen_through",
                        label: "In the last 12 months, how many deals fell through AFTER being under contract?",
                        type: "select",
                        options: ["We don't track this", "0 deals", "1-3 deals", "4-8 deals", "9-15 deals", "15+ deals"],
                        scoring: { "We don't track this": 0, "0 deals": 5, "1-3 deals": 20, "4-8 deals": 15, "9-15 deals": 10, "15+ deals": 5 }
                    },
                    {
                        id: "failed_deal_causes",
                        label: "Of those failed deals, what percentage were due to missed deadlines, inspection issues, or document problems?",
                        type: "select",
                        options: ["Don't know/Can't say", "Less than 25%", "25-50%", "50-75%", "75-100%"],
                        scoring: { "Don't know/Can't say": 0, "Less than 25%": 20, "25-50%": 15, "50-75%": 10, "75-100%": 5 }
                    },
                    {
                        id: "lost_commission_value",
                        label: "Based on your average commission per deal, what's the approximate dollar value of lost commissions from failed deals in the last 12 months?",
                        type: "select",
                        options: ["Haven't calculated", "Under $50K", "$50K-$150K", "$150K-$300K", "$300K-$500K", "Over $500K"],
                        scoring: { "Haven't calculated": 0, "Under $50K": 25, "$50K-$150K": 20, "$150K-$300K": 15, "$300K-$500K": 10, "Over $500K": 5 }
                    }
                ]
            },
            deadlineVisibility: {
                title: "Deadline Visibility Gap",
                questions: [
                    {
                        id: "inspection_deadlines_visibility",
                        label: "Right now, without looking anything up, how many of your agents have inspection deadlines in the next 7 days?",
                        type: "select",
                        options: ["Can tell you the exact number", "Could find out in under 5 minutes", "Would need to ask TCs or agents", "Would take 30+ minutes to compile", "Don't know and can't easily find out"],
                        scoring: { "Can tell you the exact number": 35, "Could find out in under 5 minutes": 25, "Would need to ask TCs or agents": 15, "Would take 30+ minutes to compile": 5, "Don't know and can't easily find out": 0 }
                    },
                    {
                        id: "at_risk_deals",
                        label: "How many deals closing THIS MONTH could be at risk due to financing delays or appraisal issues?",
                        type: "select",
                        options: ["Can tell you exactly which deals and why", "Could find out with some calls/research", "Would need to ask each agent", "No way to know until problems surface"],
                        scoring: { "Can tell you exactly which deals and why": 35, "Could find out with some calls/research": 20, "Would need to ask each agent": 10, "No way to know until problems surface": 0 }
                    },
                    {
                        id: "addendum_deadline_handling",
                        label: "When an addendum changes a closing date, what happens to all the related deadlines (inspection, financing, appraisal)?",
                        type: "select",
                        options: ["System automatically recalculates everything", "TC manually updates all dependent dates", "Agent is responsible for catching it", "We hope everyone notices and adjusts", "Usually gets missed until there's a problem"],
                        scoring: { "System automatically recalculates everything": 30, "TC manually updates all dependent dates": 20, "Agent is responsible for catching it": 10, "We hope everyone notices and adjusts": 5, "Usually gets missed until there's a problem": 0 }
                    }
                ]
            },
            documentIntelligence: {
                title: "Document Intelligence",
                questions: [
                    {
                        id: "date_extraction_time",
                        label: "When a TC uploads a purchase agreement, how long until all critical dates are in your tracking system?",
                        type: "select",
                        options: ["Extracted automatically in under 30 seconds", "TC enters manually within same day", "Agent enters when they get around to it", "We don't systematically extract all dates", "What tracking system?"],
                        scoring: { "Extracted automatically in under 30 seconds": 35, "TC enters manually within same day": 20, "Agent enters when they get around to it": 10, "We don't systematically extract all dates": 5, "What tracking system?": 0 }
                    },
                    {
                        id: "inspection_deadline_check",
                        label: "How do you know if an inspection deadline is too short for your market?",
                        type: "select",
                        options: ["System compares to our standards and flags it", "Experienced TC/broker notices during review", "We realize it during inspection period when time is tight", "We don't proactively check this"],
                        scoring: { "System compares to our standards and flags it": 35, "Experienced TC/broker notices during review": 20, "We realize it during inspection period when time is tight": 10, "We don't proactively check this": 0 }
                    },
                    {
                        id: "document_conflict_detection",
                        label: "When HOA documents contradict something in the purchase agreement (e.g., rental restrictions), how do you catch it?",
                        type: "select",
                        options: ["AI cross-references all transaction documents automatically", "TC manually reviews for conflicts", "Hoping agent notices during their review", "Usually only catch it if client asks or title finds it", "We've had deals fall apart from this"],
                        scoring: { "AI cross-references all transaction documents automatically": 35, "TC manually reviews for conflicts": 20, "Hoping agent notices during their review": 10, "Usually only catch it if client asks or title finds it": 5, "We've had deals fall apart from this": 0 }
                    }
                ]
            },
            agentKnowledge: {
                title: "Agent Knowledge & Consistency",
                questions: [
                    {
                        id: "after_hours_policy_access",
                        label: "At 11 PM on a Saturday, can your agents instantly find your brokerage's policy on dual agency disclosure / commission splits / required forms?",
                        type: "select",
                        options: ["Yes, AI assistant trained on our docs, available 24/7", "Yes, searchable knowledge base", "They'd text/email someone and wait for response", "They'd have to wait until Monday to ask", "They'd probably just guess based on what they remember"],
                        scoring: { "Yes, AI assistant trained on our docs, available 24/7": 35, "Yes, searchable knowledge base": 25, "They'd text/email someone and wait for response": 15, "They'd have to wait until Monday to ask": 5, "They'd probably just guess based on what they remember": 0 }
                    },
                    {
                        id: "agent_consistency",
                        label: "How many different ways do your agents handle the same situation (e.g., writing up dual agency)?",
                        type: "select",
                        options: ["One consistent way - we have documented standards", "Mostly consistent with minor variations", "Each experienced agent has their own approach", "New agents copy whoever trained them", "Wide variation - \"every agent does it differently\""],
                        scoring: { "One consistent way - we have documented standards": 30, "Mostly consistent with minor variations": 20, "Each experienced agent has their own approach": 10, "New agents copy whoever trained them": 5, "Wide variation - \"every agent does it differently\"": 0 }
                    },
                    {
                        id: "policy_update_compliance",
                        label: "When you update a brokerage policy, how do you ensure compliance?",
                        type: "select",
                        options: ["System requires acknowledgment, tracks who's read it, tests understanding", "Email to all agents with tracking", "Announce in meeting, hope they remember", "Post to shared drive, assume they'll see it", "Tell people informally as it comes up"],
                        scoring: { "System requires acknowledgment, tracks who's read it, tests understanding": 35, "Email to all agents with tracking": 20, "Announce in meeting, hope they remember": 10, "Post to shared drive, assume they'll see it": 5, "Tell people informally as it comes up": 0 }
                    }
                ]
            },
            clientExperienceLiability: {
                title: "Client Experience & Liability",
                questions: [
                    {
                        id: "after_hours_client_support",
                        label: "How do your clients get answers to transaction questions at 10 PM on a Sunday?",
                        type: "select",
                        options: ["AI chatbot with their specific transaction documents", "Agent responds to texts/calls when available", "They wait until Monday morning", "They Google it and might get wrong answers", "They get anxious and call multiple people"],
                        scoring: { "AI chatbot with their specific transaction documents": 35, "Agent responds to texts/calls when available": 20, "They wait until Monday morning": 10, "They Google it and might get wrong answers": 5, "They get anxious and call multiple people": 0 }
                    },
                    {
                        id: "client_document_understanding",
                        label: "What percentage of your clients actually understand what they're signing?",
                        type: "select",
                        options: ["90%+ thanks to AI summaries and chatbot", "75%+ through good agent explanation", "50-75% - depends on agent and client", "25-50% - most just trust their agent", "Under 25% - they mostly just sign"],
                        scoring: { "90%+ thanks to AI summaries and chatbot": 35, "75%+ through good agent explanation": 25, "50-75% - depends on agent and client": 15, "25-50% - most just trust their agent": 8, "Under 25% - they mostly just sign": 0 }
                    },
                    {
                        id: "closing_delays",
                        label: "How often do document/paperwork issues delay your closings?",
                        type: "select",
                        options: ["Never - we catch everything early", "Rarely - maybe 1-2 times per year", "Occasionally - 3-5 times per year", "Regularly - 6-10 times per year", "Frequently - happens all the time"],
                        scoring: { "Never - we catch everything early": 35, "Rarely - maybe 1-2 times per year": 25, "Occasionally - 3-5 times per year": 15, "Regularly - 6-10 times per year": 8, "Frequently - happens all the time": 0 }
                    }
                ]
            },
            eoRiskProtection: {
                title: "E&O Risk & Protection",
                questions: [
                    {
                        id: "eo_claims_history",
                        label: "E&O claims or near-misses in the last 2 years?",
                        type: "select",
                        options: ["0 claims, 0 near-misses", "0 claims, 1-2 near-misses", "0 claims, 3+ near-misses", "1 claim", "2+ claims"],
                        scoring: { "0 claims, 0 near-misses": 34, "0 claims, 1-2 near-misses": 25, "0 claims, 3+ near-misses": 15, "1 claim": 8, "2+ claims": 0 }
                    },
                    {
                        id: "liability_risk_awareness",
                        label: "Do you know which of your current transactions have the highest liability risk?",
                        type: "select",
                        options: ["Yes - system scores risk and flags issues automatically", "Somewhat - experienced broker/TC flags concerning deals", "Not really - we treat all deals the same", "No - we only know when something goes wrong"],
                        scoring: { "Yes - system scores risk and flags issues automatically": 33, "Somewhat - experienced broker/TC flags concerning deals": 20, "Not really - we treat all deals the same": 10, "No - we only know when something goes wrong": 0 }
                    }
                ]
            }
        };

        // Scoring calculation function
        const calculateScores = (responses) => {
            let scores = {
                dealFailureReality: 0,
                deadlineVisibility: 0,
                documentIntelligence: 0,
                agentKnowledge: 0,
                clientExperienceLiability: 0,
                eoRiskProtection: 0,
                overall: 0
            };

            // Calculate category scores
            Object.entries(assessmentQuestions).forEach(([category, data]) => {
                if (category !== 'companyInfo') {
                    let categoryScore = 0;
                    data.questions.forEach(question => {
                        if (question.scoring && responses[question.id]) {
                            categoryScore += question.scoring[responses[question.id]] || 0;
                        }
                    });
                    scores[category] = categoryScore;
                }
            });

            // Calculate overall score
            const totalScore = scores.dealFailureReality + scores.deadlineVisibility +
                              scores.documentIntelligence + scores.agentKnowledge +
                              scores.clientExperienceLiability + scores.eoRiskProtection;

            // Total possible: 512 points (45+100+105+100+95+67)
            scores.overall = Math.round((totalScore / 512) * 100);

            // Determine risk level based on new scoring framework
            if (scores.overall >= 88) {
                scores.riskLevel = "LEADER";
                scores.riskDescription = "Transaction Intelligence Leader";
            } else if (scores.overall >= 71) {
                scores.riskLevel = "MODERATE";
                scores.riskDescription = "Moderate Risk with Gaps";
            } else if (scores.overall >= 53) {
                scores.riskLevel = "HIGH";
                scores.riskDescription = "High Risk - Flying Blind";
            } else if (scores.overall >= 35) {
                scores.riskLevel = "CRITICAL";
                scores.riskDescription = "Critical Risk";
            } else {
                scores.riskLevel = "EXISTENTIAL";
                scores.riskDescription = "Existential Threat";
            }

            // Determine percentile
            if (scores.overall >= 88) scores.percentile = "Top 5%";
            else if (scores.overall >= 71) scores.percentile = "Top 25%";
            else if (scores.overall >= 53) scores.percentile = "Top 50%";
            else scores.percentile = "Bottom 50%";

            // Calculate estimated annual losses based on score
            if (scores.overall >= 88) {
                scores.estimatedLosses = "Under $50K";
            } else if (scores.overall >= 71) {
                scores.estimatedLosses = "$75K-$150K";
            } else if (scores.overall >= 53) {
                scores.estimatedLosses = "$150K-$300K+";
            } else if (scores.overall >= 35) {
                scores.estimatedLosses = "$300K+";
            } else {
                scores.estimatedLosses = "Significant financial exposure";
            }

            return scores;
        };

        // Main App Component
        const BrokerageIntelligenceApp = () => {
            const [currentStep, setCurrentStep] = useState(0);
            const [responses, setResponses] = useState({});
            const [scores, setScores] = useState(null);
            const [showReport, setShowReport] = useState(false);
            const [email, setEmail] = useState('');
            const [emailCaptured, setEmailCaptured] = useState(false);

            const categories = Object.keys(assessmentQuestions);
            const currentCategory = categories[currentStep];
            const currentQuestions = assessmentQuestions[currentCategory];
            const progress = ((currentStep + 1) / categories.length) * 100;

            const handleInputChange = (questionId, value) => {
                setResponses(prev => ({
                    ...prev,
                    [questionId]: value
                }));
            };

            const handleNext = () => {
                if (currentStep < categories.length - 1) {
                    setCurrentStep(currentStep + 1);
                } else {
                    // Calculate scores and show report
                    const calculatedScores = calculateScores(responses);
                    setScores(calculatedScores);
                    setShowReport(true);
                }
            };

            const handlePrevious = () => {
                if (currentStep > 0) {
                    setCurrentStep(currentStep - 1);
                }
            };

            const isCurrentStepValid = () => {
                const questions = currentQuestions.questions;
                return questions.every(q => !q.required || responses[q.id]);
            };

            const handleEmailSubmit = async (e) => {
                e.preventDefault();

                try {
                    // Step 1: Save assessment to database
                    const assessmentData = {
                        companyInfo: {
                            company_name: responses.company_name,
                            agent_count: responses.agent_count,
                            monthly_deals: responses.monthly_deals,
                            location: responses.location
                        },
                        responses,
                        scores,
                        timestamp: new Date().toISOString()
                    };

                    const submitResponse = await fetch('/api/assessment-submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(assessmentData)
                    });

                    if (!submitResponse.ok) {
                        throw new Error('Failed to save assessment');
                    }

                    const submitResult = await submitResponse.json();
                    const assessmentId = submitResult.assessmentId;

                    console.log('‚úÖ Assessment saved:', assessmentId);

                    // Step 2: Capture email and trigger ActiveCampaign
                    const emailData = {
                        email,
                        assessmentId,
                        reportData: {
                            companyName: responses.company_name,
                            brokerageSize: responses.agent_count,
                            city: responses.location,
                            overallScore: scores.overall,
                            riskLevel: scores.riskLevel,
                            monthlyTransactions: responses.monthly_deals
                        }
                    };

                    const emailResponse = await fetch('/api/email-capture', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(emailData)
                    });

                    if (!emailResponse.ok) {
                        throw new Error('Failed to capture email');
                    }

                    const emailResult = await emailResponse.json();
                    console.log('‚úÖ Email captured:', emailResult);

                    // Store assessment ID and report URL for display
                    window.assessmentId = assessmentId;
                    window.reportUrl = `${window.location.origin}/report.html?id=${assessmentId}`;

                    setEmailCaptured(true);

                } catch (error) {
                    console.error('‚ùå Error submitting assessment:', error);
                    alert('There was an error saving your assessment. Please try again.');
                }
            };

            if (showReport) {
                return <ReportView 
                    responses={responses} 
                    scores={scores} 
                    emailCaptured={emailCaptured}
                    email={email}
                    setEmail={setEmail}
                    handleEmailSubmit={handleEmailSubmit}
                />;
            }

            return (
                <div className="min-h-screen bg-mist">
                    {/* Header */}
                    <header className="bg-white shadow-sm no-print">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                            <h1 className="text-2xl font-bebas text-storm-gray">Brokerage Intelligence Assessment</h1>
                        </div>
                    </header>

                    {/* Progress Bar */}
                    <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
                        <div className="bg-white rounded-lg shadow p-6">
                            <div className="mb-4">
                                <div className="flex justify-between text-sm font-manrope font-medium text-storm-gray mb-2">
                                    <span>Progress</span>
                                    <span className="font-jetbrains">{Math.round(progress)}% Complete</span>
                                </div>
                                <div className="w-full bg-sea-glass/30 rounded-full h-2">
                                    <div
                                        className="bg-spruce h-2 rounded-full transition-all duration-300"
                                        style={{ width: `${progress}%` }}
                                    />
                                </div>
                            </div>

                            {/* Current Section */}
                            <div className="mb-6">
                                <h2 className="text-xl font-manrope font-bold text-storm-gray mb-4">
                                    {currentQuestions.title}
                                </h2>
                                
                                {/* Questions */}
                                <div className="space-y-4">
                                    {currentQuestions.questions.map((question) => (
                                        <div key={question.id} className="mb-4">
                                            <label className="block text-sm font-manrope font-medium text-storm-gray mb-2">
                                                {question.label}
                                                {question.required && <span className="text-signal-red ml-1">*</span>}
                                            </label>

                                            {question.type === 'text' && (
                                                <input
                                                    type="text"
                                                    className="w-full px-3 py-2 border-2 border-sea-glass rounded-md focus:outline-none focus:ring-2 focus:ring-spruce focus:border-spruce font-manrope text-storm-gray"
                                                    value={responses[question.id] || ''}
                                                    onChange={(e) => handleInputChange(question.id, e.target.value)}
                                                    required={question.required}
                                                />
                                            )}

                                            {question.type === 'select' && (
                                                <select
                                                    className="w-full px-3 py-2 border-2 border-sea-glass rounded-md focus:outline-none focus:ring-2 focus:ring-spruce focus:border-spruce font-manrope text-storm-gray"
                                                    value={responses[question.id] || ''}
                                                    onChange={(e) => handleInputChange(question.id, e.target.value)}
                                                    required={question.required}
                                                >
                                                    <option value="">Select an option</option>
                                                    {question.options.map(option => (
                                                        <option key={option} value={option}>{option}</option>
                                                    ))}
                                                </select>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Navigation Buttons */}
                            <div className="flex justify-between">
                                <button
                                    onClick={handlePrevious}
                                    disabled={currentStep === 0}
                                    className="px-4 py-2 bg-sea-glass/50 text-storm-gray font-manrope font-semibold rounded-md hover:bg-sea-glass disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                >
                                    Previous
                                </button>
                                <button
                                    onClick={handleNext}
                                    disabled={!isCurrentStepValid()}
                                    className="px-6 py-2 bg-river-stone text-white font-manrope font-semibold rounded-md hover:bg-spruce disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                >
                                    {currentStep === categories.length - 1 ? 'See Your Results' : 'Next'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Report Component
        const ReportView = ({ responses, scores, emailCaptured, email, setEmail, handleEmailSubmit }) => {
            const chartRef = useRef(null);
            const radarChartRef = useRef(null);

            useEffect(() => {
                // Draw gauge chart for overall score
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            datasets: [{
                                data: [scores.overall, 100 - scores.overall],
                                backgroundColor: [
                                    scores.overall >= 85 ? '#607D3B' :  // Fern for LOW risk
                                    scores.overall >= 70 ? '#F59E0B' :  // Amber for MODERATE
                                    scores.overall >= 50 ? '#F59E0B' :  // Amber for HIGH
                                    '#CC0000',                           // Signal Red for CRITICAL
                                    '#9DBFBF'                            // Sea Glass for remainder
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            circumference: 180,
                            rotation: 270,
                            cutout: '75%',
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: false }
                            }
                        }
                    });
                }

                // Draw radar chart for category scores
                if (radarChartRef.current) {
                    const ctx = radarChartRef.current.getContext('2d');
                    new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: [
                                'Deal Failure Reality',
                                'Deadline Visibility',
                                'Document Intelligence',
                                'Agent Knowledge',
                                'Client Experience',
                                'E&O Risk'
                            ],
                            datasets: [{
                                label: 'Your Score',
                                data: [
                                    scores.dealFailureReality,
                                    scores.deadlineVisibility,
                                    scores.documentIntelligence,
                                    scores.agentKnowledge,
                                    scores.clientExperienceLiability,
                                    scores.eoRiskProtection
                                ],
                                backgroundColor: 'rgba(120, 144, 156, 0.2)',  // River Stone
                                borderColor: 'rgb(120, 144, 156)',            // River Stone
                                pointBackgroundColor: 'rgb(120, 144, 156)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgb(120, 144, 156)'
                            }, {
                                label: 'Top 5% Benchmark',
                                data: [40, 95, 100, 95, 90, 65],
                                backgroundColor: 'rgba(96, 125, 59, 0.2)',    // Fern
                                borderColor: 'rgb(96, 125, 59)',              // Fern
                                pointBackgroundColor: 'rgb(96, 125, 59)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgb(96, 125, 59)'
                            }]
                        },
                        options: {
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    max: 105
                                }
                            }
                        }
                    });
                }
            }, [scores]);

            // Identify top gaps
            const gaps = [
                { name: 'Deal Failure Reality', score: scores.dealFailureReality, max: 45 },
                { name: 'Deadline Visibility', score: scores.deadlineVisibility, max: 100 },
                { name: 'Document Intelligence', score: scores.documentIntelligence, max: 105 },
                { name: 'Agent Knowledge', score: scores.agentKnowledge, max: 100 },
                { name: 'Client Experience', score: scores.clientExperienceLiability, max: 95 },
                { name: 'E&O Risk', score: scores.eoRiskProtection, max: 67 }
            ].sort((a, b) => (a.score/a.max) - (b.score/b.max)).slice(0, 3);

            return (
                <div className="min-h-screen bg-mist py-8">
                    <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                        {/* Report Header */}
                        <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                            <div className="text-center mb-8">
                                <h1 className="text-4xl font-bebas text-spruce mb-2 tracking-wide">
                                    Brokerage Intelligence Report
                                </h1>
                                <p className="text-xl font-manrope font-semibold text-storm-gray">
                                    {responses.company_name || 'Your Brokerage'}
                                </p>
                            </div>

                            {/* Overall Score Section */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                <div className="text-center">
                                    <h2 className="text-2xl font-manrope font-bold text-storm-gray mb-4">Overall Score</h2>
                                    <div className="relative inline-block">
                                        <canvas ref={chartRef} width="250" height="150"></canvas>
                                        <div className="absolute inset-0 flex items-center justify-center mt-8">
                                            <div>
                                                <div className="text-5xl font-jetbrains font-bold text-spruce">{scores.overall}</div>
                                                <div className="text-sm font-manrope text-storm-gray">out of 100</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className={`mt-4 inline-block px-4 py-2 rounded-full text-white font-manrope font-semibold ${
                                        scores.riskLevel === 'LEADER' ? 'bg-fern' :
                                        scores.riskLevel === 'MODERATE' ? 'bg-amber' :
                                        scores.riskLevel === 'HIGH' ? 'bg-amber' : 'bg-signal-red'
                                    }`}>
                                        {scores.riskDescription || scores.riskLevel}
                                    </div>
                                </div>

                                <div>
                                    <h2 className="text-2xl font-manrope font-bold text-storm-gray mb-4">Performance Breakdown</h2>
                                    <canvas ref={radarChartRef} width="300" height="300"></canvas>
                                </div>
                            </div>

                        </div>

                        {/* Brief Deficiency Teaser */}
                        <div className="bg-white rounded-lg shadow-lg p-8 mb-6 border-2 border-signal-red">
                            <div className="text-center">
                                <div className="text-5xl mb-4">‚ö†Ô∏è</div>
                                <h2 className="text-3xl font-bebas text-signal-red mb-4 tracking-wide">
                                    We Identified {gaps.length} Critical Operational Gaps
                                </h2>
                                <p className="text-xl font-manrope text-storm-gray mb-2">
                                    These inefficiencies are costing your brokerage an estimated{' '}
                                    <span className="font-bold text-signal-red font-jetbrains">
                                        ${scores.overall < 50 ? '127,000' : scores.overall < 70 ? '85,000' : '50,000'}+
                                    </span>{' '}
                                    per year in wasted time, missed deals, and liability exposure.
                                </p>
                                <p className="text-lg font-manrope text-storm-gray/80">
                                    Your complete report reveals exactly what's causing these gaps and how top brokerages have eliminated them.
                                </p>
                            </div>
                        </div>

                        {/* PROMINENT EMAIL CAPTURE */}
                        {!emailCaptured ? (
                            <div className="bg-gradient-to-br from-spruce to-storm-gray rounded-lg shadow-2xl p-10 mb-6 text-white">
                                <div className="text-center max-w-4xl mx-auto">
                                    <h2 className="text-4xl md:text-5xl font-bebas mb-4 tracking-wide leading-tight">
                                        Want to See Your Full Report and How Top Brokerages Are Saving $50,000+/Year Using Technology?
                                    </h2>
                                    <p className="text-xl font-manrope mb-8 text-white/90">
                                        Discover the exact systems and capabilities your brokerage can integrate within the next 30-90 days to eliminate inefficiencies and scale profitably.
                                    </p>

                                    {/* Value Props */}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-left">
                                        <div className="bg-white/10 backdrop-blur rounded-lg p-5 border border-white/20">
                                            <div className="text-3xl mb-3">üéØ</div>
                                            <h3 className="font-bold text-lg mb-2">Detailed Gap Analysis</h3>
                                            <p className="text-sm text-white/80">See exactly what's broken, why it matters, and the hidden costs</p>
                                        </div>
                                        <div className="bg-white/10 backdrop-blur rounded-lg p-5 border border-white/20">
                                            <div className="text-3xl mb-3">üó∫Ô∏è</div>
                                            <h3 className="font-bold text-lg mb-2">30-90 Day Roadmap</h3>
                                            <p className="text-sm text-white/80">Prioritized action plan with quick wins and transformational changes</p>
                                        </div>
                                        <div className="bg-white/10 backdrop-blur rounded-lg p-5 border border-white/20">
                                            <div className="text-3xl mb-3">üí∞</div>
                                            <h3 className="font-bold text-lg mb-2">ROI Projections</h3>
                                            <p className="text-sm text-white/80">Quantified savings based on your brokerage's actual operations</p>
                                        </div>
                                    </div>

                                    {/* Email Form */}
                                    <form onSubmit={handleEmailSubmit} className="max-w-2xl mx-auto">
                                        <div className="bg-white rounded-lg p-2 shadow-xl flex flex-col sm:flex-row gap-2">
                                            <input
                                                type="email"
                                                value={email}
                                                onChange={(e) => setEmail(e.target.value)}
                                                placeholder="Enter your work email to unlock your full report"
                                                required
                                                className="flex-1 px-6 py-4 border-0 rounded-md focus:outline-none focus:ring-2 focus:ring-spruce font-manrope text-lg text-storm-gray"
                                            />
                                            <button
                                                type="submit"
                                                className="px-8 py-4 bg-signal-red text-white font-manrope font-bold rounded-md hover:bg-signal-red/90 transition-colors text-lg whitespace-nowrap shadow-lg"
                                            >
                                                Get My Full Report ‚Üí
                                            </button>
                                        </div>
                                    </form>

                                    {/* Trust Indicators */}
                                    <div className="mt-6 flex flex-wrap items-center justify-center gap-6 text-sm text-white/80">
                                        <div className="flex items-center gap-2">
                                            <span>‚úì</span>
                                            <span>Instant access (no wait)</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span>‚úì</span>
                                            <span>No credit card required</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span>‚úì</span>
                                            <span>Based on 1,000+ assessments</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span>üîí</span>
                                            <span>Your data is 100% secure</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                                <div className="bg-fern/10 border-2 border-fern rounded-lg p-6">
                                    <h3 className="text-xl font-manrope font-bold mb-3 text-fern">‚úÖ Report Saved!</h3>
                                    <p className="font-manrope text-storm-gray mb-4">
                                        Your assessment has been saved. Check your email for the complete intelligence report, or access it anytime using the link below.
                                    </p>

                                    {window.reportUrl && (
                                        <div className="bg-white border-2 border-sea-glass rounded-md p-4 mb-4">
                                            <p className="text-sm font-manrope font-medium text-storm-gray mb-2">Your Report URL:</p>
                                            <div className="flex items-center gap-2">
                                                <input
                                                    type="text"
                                                    value={window.reportUrl}
                                                    readOnly
                                                    className="flex-1 px-3 py-2 text-sm font-jetbrains bg-mist border-2 border-sea-glass rounded"
                                                />
                                                <button
                                                    onClick={() => {
                                                        navigator.clipboard.writeText(window.reportUrl);
                                                        alert('Report link copied to clipboard!');
                                                    }}
                                                    className="px-4 py-2 bg-storm-gray text-white text-sm font-manrope font-semibold rounded hover:bg-spruce transition-colors"
                                                >
                                                    Copy
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    <p className="text-sm font-manrope text-storm-gray mb-4">You'll also receive via email:</p>
                                    <ul className="list-disc list-inside font-manrope text-storm-gray text-sm mb-4">
                                        <li>Your full intelligence report with detailed insights</li>
                                        <li>Weekly industry insights and best practices</li>
                                        <li>Exclusive benchmarking updates</li>
                                    </ul>

                                    <div className="flex flex-wrap gap-3 no-print">
                                        {window.reportUrl && (
                                            <a
                                                href={window.reportUrl}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                className="px-6 py-2 bg-fern text-white font-manrope font-semibold rounded-md hover:bg-spruce flex items-center gap-2 transition-colors"
                                            >
                                                <span>üìä</span> View Full Report
                                            </a>
                                        )}
                                        <button
                                            onClick={() => window.print()}
                                            className="px-6 py-2 bg-river-stone text-white font-manrope font-semibold rounded-md hover:bg-spruce flex items-center gap-2 transition-colors"
                                        >
                                            <span>üìÑ</span> Download PDF
                                        </button>
                                        <button
                                            onClick={() => {
                                                const urlToCopy = window.reportUrl || window.location.href;
                                                navigator.clipboard.writeText(urlToCopy);
                                                alert('Report link copied! Share it with your team.');
                                            }}
                                            className="px-6 py-2 bg-storm-gray text-white font-manrope font-semibold rounded-md hover:bg-spruce flex items-center gap-2 transition-colors"
                                        >
                                            <span>üîó</span> Share Report
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* What Top Performers Do Section (visible after email) */}
                        {emailCaptured && (
                            <div className="bg-white rounded-lg shadow-lg p-8 mb-6 print-break">
                                <h2 className="text-2xl font-bebas text-spruce mb-6 tracking-wide">What the Top 5% Do Differently</h2>

                                <div className="space-y-6">
                                    <div className="border-l-4 border-spruce pl-4">
                                        <h3 className="font-manrope font-bold text-lg mb-2 text-storm-gray">Transaction Oversight</h3>
                                        <p className="font-manrope text-storm-gray">
                                            Elite brokerages use AI-powered monitoring that reviews 100% of transactions in real-time,
                                            catching issues before they become problems. They maintain less than 1% error rate compared
                                            to the industry average of 15%.
                                        </p>
                                    </div>

                                    <div className="border-l-4 border-spruce pl-4">
                                        <h3 className="font-manrope font-bold text-lg mb-2 text-storm-gray">Knowledge Management</h3>
                                        <p className="font-manrope text-storm-gray">
                                            Top performers capture every lesson learned and encode it into their systems. New agents
                                            reach full productivity in 6 weeks versus the 6-month industry average.
                                        </p>
                                    </div>

                                    <div className="border-l-4 border-spruce pl-4">
                                        <h3 className="font-manrope font-bold text-lg mb-2 text-storm-gray">Client Experience</h3>
                                        <p className="font-manrope text-storm-gray">
                                            Leading brokerages provide 24/7 transaction visibility through AI chatbots and portals,
                                            resulting in 67% more referrals from satisfied clients.
                                        </p>
                                    </div>

                                    <div className="border-l-4 border-spruce pl-4">
                                        <h3 className="font-manrope font-bold text-lg mb-2 text-storm-gray">Risk Management</h3>
                                        <p className="font-manrope text-storm-gray">
                                            Elite firms predict and prevent issues with AI risk scoring, reducing E&O claims by 80%
                                            and saving an average of $45,000 annually in liability costs.
                                        </p>
                                    </div>
                                </div>

                                {/* Action Plan */}
                                <div className="mt-8 bg-mist rounded-lg p-6">
                                    <h3 className="text-xl font-manrope font-bold text-storm-gray mb-4">Your 30-Day Quick Wins</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="bg-white rounded p-4 border-2 border-sea-glass">
                                            <div className="font-manrope font-bold text-spruce mb-2">Week 1</div>
                                            <ul className="text-sm font-manrope text-storm-gray space-y-1">
                                                <li>‚Ä¢ Implement deadline checklist</li>
                                                <li>‚Ä¢ Create contract templates</li>
                                                <li>‚Ä¢ Set up daily huddles</li>
                                            </ul>
                                        </div>
                                        <div className="bg-white rounded p-4 border-2 border-sea-glass">
                                            <div className="font-manrope font-bold text-spruce mb-2">Week 2-3</div>
                                            <ul className="text-sm font-manrope text-storm-gray space-y-1">
                                                <li>‚Ä¢ Build knowledge library</li>
                                                <li>‚Ä¢ Launch client portal</li>
                                                <li>‚Ä¢ Train on best practices</li>
                                            </ul>
                                        </div>
                                        <div className="bg-white rounded p-4 border-2 border-sea-glass">
                                            <div className="font-manrope font-bold text-spruce mb-2">Week 4</div>
                                            <ul className="text-sm font-manrope text-storm-gray space-y-1">
                                                <li>‚Ä¢ Measure improvements</li>
                                                <li>‚Ä¢ Gather agent feedback</li>
                                                <li>‚Ä¢ Plan automation phase</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                {/* ROI Calculator Preview */}
                                <div className="mt-8 bg-spruce/10 rounded-lg p-6 border-2 border-spruce">
                                    <h3 className="text-xl font-manrope font-bold text-spruce mb-4">Potential ROI from Improvements</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <p className="font-manrope text-storm-gray mb-2">Based on {responses.agent_count} agents and {responses.monthly_deals} monthly deals:</p>
                                            <ul className="space-y-2 font-manrope text-storm-gray">
                                                <li>‚Ä¢ Time savings: <span className="font-semibold font-jetbrains">600 hours/month</span></li>
                                                <li>‚Ä¢ Risk reduction: <span className="font-semibold font-jetbrains">$36,000/year saved</span></li>
                                                <li>‚Ä¢ Deal saves: <span className="font-semibold font-jetbrains">5 deals/month recovered</span></li>
                                            </ul>
                                        </div>
                                        <div className="bg-white rounded p-4 text-center border-2 border-sea-glass">
                                            <div className="text-3xl font-jetbrains font-bold text-fern">$58,000</div>
                                            <div className="font-manrope text-storm-gray">Monthly Value Created</div>
                                            <div className="mt-2 text-2xl font-jetbrains font-bold text-spruce">38X ROI</div>
                                            <div className="font-manrope text-storm-gray">on Technology Investment</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Backend Integration Guide Component
        const IntegrationGuide = () => {
            return (
                <div className="max-w-4xl mx-auto p-8 bg-white rounded-lg shadow-lg mt-8">
                    <h2 className="text-2xl font-bold mb-6">Backend Integration Guide</h2>
                    
                    <div className="space-y-6">
                        <div className="border-l-4 border-blue-500 pl-4">
                            <h3 className="font-semibold text-lg mb-2">1. Database Schema (Supabase)</h3>
                            <pre className="bg-gray-100 p-4 rounded text-sm overflow-x-auto">
{`-- assessments table
CREATE TABLE assessments (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    email TEXT NOT NULL,
    company_name TEXT,
    agent_count TEXT,
    monthly_deals TEXT,
    location TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    report_url TEXT
);

-- scores table
CREATE TABLE scores (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    assessment_id UUID REFERENCES assessments(id),
    overall_score INTEGER,
    transaction_oversight_score INTEGER,
    knowledge_management_score INTEGER,
    client_experience_score INTEGER,
    risk_management_score INTEGER,
    risk_level TEXT,
    percentile TEXT
);

-- responses table
CREATE TABLE responses (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    assessment_id UUID REFERENCES assessments(id),
    question_id TEXT,
    response_value TEXT
);

-- gaps table
CREATE TABLE gaps (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    assessment_id UUID REFERENCES assessments(id),
    gap_category TEXT,
    gap_description TEXT,
    severity INTEGER
);`}
                            </pre>
                        </div>

                        <div className="border-l-4 border-green-500 pl-4">
                            <h3 className="font-semibold text-lg mb-2">2. ActiveCampaign Integration</h3>
                            <pre className="bg-gray-100 p-4 rounded text-sm overflow-x-auto">
{`// API endpoint to handle submission
app.post('/api/assessment/submit', async (req, res) => {
    const { email, responses, scores } = req.body;
    
    // Save to Supabase
    const { data: assessment } = await supabase
        .from('assessments')
        .insert({
            email,
            company_name: responses.company_name,
            agent_count: responses.agent_count,
            monthly_deals: responses.monthly_deals,
            location: responses.location
        })
        .select()
        .single();
    
    // Save scores
    await supabase
        .from('scores')
        .insert({
            assessment_id: assessment.id,
            ...scores
        });
    
    // Send to ActiveCampaign
    const acData = {
        contact: {
            email,
            fieldValues: [
                { field: 'COMPANY', value: responses.company_name },
                { field: 'SCORE', value: scores.overall },
                { field: 'RISK_LEVEL', value: scores.riskLevel },
                { field: 'AGENT_COUNT', value: responses.agent_count },
                { field: 'REPORT_URL', value: \`/report/\${assessment.id}\` }
            ]
        }
    };
    
    // Add tags based on score
    const tags = [];
    if (scores.overall >= 85) tags.push('Score: Elite');
    else if (scores.overall >= 70) tags.push('Score: Strong');
    else if (scores.overall >= 50) tags.push('Score: Average');
    else tags.push('Score: At-Risk');
    
    // Trigger automation
    await activeCampaign.createContact(acData);
    await activeCampaign.addTags(email, tags);
    await activeCampaign.triggerAutomation(email, 'assessment_followup');
    
    res.json({ success: true, reportId: assessment.id });
});`}
                            </pre>
                        </div>

                        <div className="border-l-4 border-purple-500 pl-4">
                            <h3 className="font-semibold text-lg mb-2">3. Report Generation Endpoint</h3>
                            <pre className="bg-gray-100 p-4 rounded text-sm overflow-x-auto">
{`app.get('/api/report/:id', async (req, res) => {
    const { id } = req.params;
    
    // Fetch assessment data
    const { data: assessment } = await supabase
        .from('assessments')
        .select('*, scores(*), responses(*), gaps(*)')
        .eq('id', id)
        .single();
    
    // Generate custom insights with GPT-4
    const insights = await generateInsights(assessment);
    
    // Return report data
    res.json({
        assessment,
        insights,
        benchmarks: getBenchmarkData(),
        recommendations: getRecommendations(assessment.scores)
    });
});`}
                            </pre>
                        </div>

                        <div className="border-l-4 border-yellow-500 pl-4">
                            <h3 className="font-semibold text-lg mb-2">4. Email Campaign Examples</h3>
                            <pre className="bg-gray-100 p-4 rounded text-sm overflow-x-auto">
{`// ActiveCampaign Automation Sequences

// Day 1: Score-specific email
Subject: "Your {{SCORE}}/100 Intelligence Score for {{COMPANY}}"
Body: Reference their specific gaps and provide one quick win

// Day 3: Biggest gap focus
Subject: "Why {{GAP_CATEGORY}} is Costing You Deals"
Body: Deep dive into their weakest area with solutions

// Day 7: Peer comparison
Subject: "How {{COMPANY}} Compares to Similar Brokerages"
Body: Show where they rank among peers

// Day 14: Risk alert
Subject: "{{RISK_LEVEL}} Risk Alert for {{COMPANY}}"
Body: Specific risks based on their score

// Day 21: Consultation offer
Subject: "Custom Roadmap for {{COMPANY}}'s Growth"
Body: Offer personalized consultation based on their data`}
                            </pre>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(
            <div>
                <BrokerageIntelligenceApp />
                {/* Uncomment to see integration guide */}
                {/* <IntegrationGuide /> */}
            </div>,
            document.getElementById('root')
        );
    </script>
</body>
</html>