<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Brokerage Intelligence Report</title>
    <!-- Version: 3.0 - Redesigned Email Capture Flow -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Manrope:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'spruce': '#264E36',
                        'river-stone': '#78909C',
                        'sea-glass': '#9DBFBF',
                        'mist': '#F5F7F7',
                        'storm-gray': '#37474F',
                        'fern': '#607D3B',
                        'bark-brown': '#6F4E37',
                        'signal-red': '#CC0000',
                        'amber': '#F59E0B'
                    },
                    fontFamily: {
                        'bebas': ['Bebas Neue', 'sans-serif'],
                        'manrope': ['Manrope', 'sans-serif'],
                        'jetbrains': ['JetBrains Mono', 'monospace']
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
        }

        h1, h2 {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.02em;
        }

        h3, h4, h5 {
            font-family: 'Manrope', sans-serif;
        }

        .font-mono, .score-display {
            font-family: 'JetBrains Mono', monospace;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-break { page-break-before: always; }
            .shadow-lg { box-shadow: none !important; }
            canvas { max-width: 100%; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const ReportPage = () => {
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [reportData, setReportData] = useState(null);
            const [aiSummary, setAiSummary] = useState(null);
            const [aiLoading, setAiLoading] = useState(false);
            const [fullAnalysis, setFullAnalysis] = useState(null);
            const [fullAnalysisLoading, setFullAnalysisLoading] = useState(false);
            const [email, setEmail] = useState('');
            const [emailSubmitting, setEmailSubmitting] = useState(false);
            const chartRef = useRef(null);
            const radarChartRef = useRef(null);
            const chartInstance = useRef(null);
            const radarChartInstance = useRef(null);

            useEffect(() => {
                const loadReport = async () => {
                    try {
                        // Get assessment ID from URL query parameter
                        const urlParams = new URLSearchParams(window.location.search);
                        const assessmentId = urlParams.get('id');

                        if (!assessmentId) {
                            setError('No report ID provided in URL');
                            setLoading(false);
                            return;
                        }

                        // Fetch report data from API
                        const response = await fetch(`/api/report-get?id=${assessmentId}`);

                        if (!response.ok) {
                            throw new Error('Failed to load report');
                        }

                        const result = await response.json();

                        if (!result.success) {
                            throw new Error(result.error || 'Failed to load report');
                        }

                        // Transform database response to expected format
                        const rawData = result.data;

                        // Build scores object from scores array
                        const scoresMap = {};
                        if (rawData.scores && Array.isArray(rawData.scores)) {
                            rawData.scores.forEach(score => {
                                const key = score.category
                                    .replace(/\s+/g, '')
                                    .replace(/^./, str => str.toLowerCase())
                                    .replace(/[A-Z]/g, letter => letter.toLowerCase());

                                if (score.category === 'Transaction Oversight') scoresMap.transactionOversight = score.score;
                                else if (score.category === 'Knowledge Management') scoresMap.knowledgeManagement = score.score;
                                else if (score.category === 'Client Experience') scoresMap.clientExperience = score.score;
                                else if (score.category === 'Risk Management') scoresMap.riskManagement = score.score;
                            });
                        }

                        const transformedData = {
                            id: rawData.id,
                            timestamp: rawData.created_at,
                            email: rawData.email,
                            companyInfo: {
                                company_name: rawData.company_name,
                                agent_count: rawData.company_size,
                                monthly_deals: rawData.monthly_transactions,
                                location: rawData.primary_market
                            },
                            scores: {
                                overall: rawData.overall_score,
                                riskLevel: rawData.risk_level,
                                percentile: rawData.percentile,
                                ...scoresMap
                            },
                            estimatedSavings: Math.round(rawData.overall_score < 50 ? 127000 : rawData.overall_score < 70 ? 85000 : 50000),
                            responses: rawData.responses,
                            gaps: rawData.gaps
                        };

                        setReportData(transformedData);
                        setLoading(false);
                    } catch (err) {
                        console.error('Error loading report:', err);
                        setError(err.message);
                        setLoading(false);
                    }
                };

                loadReport();
            }, []);

            // Load AI insights after report data is available
            useEffect(() => {
                if (!reportData || !reportData.id) {
                    console.log('[AI] Waiting for report data...', { hasReportData: !!reportData, hasId: reportData?.id });
                    return;
                }

                console.log('[AI] Starting AI insights load for assessment:', reportData.id);

                const loadAIInsights = async () => {
                    setAiLoading(true);
                    try {
                        const urlParams = new URLSearchParams(window.location.search);
                        const assessmentId = urlParams.get('id');

                        console.log('[AI] Fetching from /api/ai-preview?id=' + assessmentId);
                        const response = await fetch(`/api/ai-preview?id=${assessmentId}`);
                        const result = await response.json();

                        console.log('[AI] Response received:', result);

                        if (result.success) {
                            setAiSummary(result.summary);
                            console.log('[AI] Summary set successfully');
                        } else {
                            console.error('[AI] API returned error:', result.error);
                        }
                    } catch (err) {
                        console.error('[AI] Error loading AI insights:', err);
                        // Don't block the page if AI fails
                    } finally {
                        setAiLoading(false);
                        console.log('[AI] Loading complete');
                    }
                };

                loadAIInsights();
            }, [reportData]);

            // Load full AI analysis when email is captured
            useEffect(() => {
                if (!reportData || !reportData.email) return;

                const loadFullAnalysis = async () => {
                    setFullAnalysisLoading(true);
                    try {
                        const urlParams = new URLSearchParams(window.location.search);
                        const assessmentId = urlParams.get('id');

                        console.log('[Full Analysis] Fetching from /api/ai-full-analysis?id=' + assessmentId);
                        const response = await fetch(`/api/ai-full-analysis?id=${assessmentId}`);
                        const result = await response.json();

                        console.log('[Full Analysis] Response received:', result);

                        if (result.success) {
                            setFullAnalysis(result.analysis);
                            console.log('[Full Analysis] Analysis loaded successfully');
                        } else {
                            console.error('[Full Analysis] API returned error:', result.error);
                        }
                    } catch (err) {
                        console.error('[Full Analysis] Error loading full analysis:', err);
                    } finally {
                        setFullAnalysisLoading(false);
                    }
                };

                loadFullAnalysis();
            }, [reportData?.email]);

            // Handle email submission to unlock full report
            const handleEmailSubmit = async (e) => {
                e.preventDefault();
                setEmailSubmitting(true);

                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const assessmentId = urlParams.get('id');

                    const emailData = {
                        email,
                        assessmentId,
                        reportData: {
                            companyName: reportData.companyInfo?.companyName,
                            brokerageSize: reportData.companyInfo?.agentCount,
                            city: reportData.companyInfo?.location,
                            overallScore: reportData.scores?.overall,
                            riskLevel: reportData.scores?.riskLevel,
                            monthlyTransactions: reportData.companyInfo?.monthlyDeals
                        }
                    };

                    const response = await fetch('/api/email-capture', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(emailData)
                    });

                    if (!response.ok) {
                        throw new Error('Failed to capture email');
                    }

                    const result = await response.json();
                    console.log('‚úÖ Email captured:', result);

                    // Update reportData to include email
                    setReportData({
                        ...reportData,
                        email: email
                    });

                    // Scroll to full report section
                    window.scrollTo({ top: 0, behavior: 'smooth' });

                } catch (err) {
                    console.error('Error submitting email:', err);
                    alert('Failed to unlock report. Please try again.');
                } finally {
                    setEmailSubmitting(false);
                }
            };

            useEffect(() => {
                if (!reportData || !reportData.scores) return;

                // Clean up existing charts
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }
                if (radarChartInstance.current) {
                    radarChartInstance.current.destroy();
                }

                // Draw gauge chart for overall score
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            datasets: [{
                                data: [reportData.scores.overall, 100 - reportData.scores.overall],
                                backgroundColor: [
                                    reportData.scores.overall >= 85 ? '#607D3B' :  // Fern for LOW risk
                                    reportData.scores.overall >= 70 ? '#F59E0B' :  // Amber for MODERATE
                                    reportData.scores.overall >= 50 ? '#F59E0B' :  // Amber for HIGH
                                    '#CC0000',                                       // Signal Red for CRITICAL
                                    '#9DBFBF'                                        // Sea Glass for remainder
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            circumference: 180,
                            rotation: 270,
                            cutout: '75%',
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: false }
                            }
                        }
                    });
                }

                // Draw radar chart for category scores
                if (radarChartRef.current) {
                    const ctx = radarChartRef.current.getContext('2d');
                    radarChartInstance.current = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: [
                                'Transaction Oversight',
                                'Knowledge Management',
                                'Client Experience',
                                'Risk Management'
                            ],
                            datasets: [{
                                label: 'Your Score',
                                data: [
                                    reportData.scores.transactionOversight || 0,
                                    reportData.scores.knowledgeManagement || 0,
                                    reportData.scores.clientExperience || 0,
                                    reportData.scores.riskManagement || 0
                                ],
                                backgroundColor: 'rgba(120, 144, 156, 0.2)',  // River Stone
                                borderColor: 'rgb(120, 144, 156)',            // River Stone
                                pointBackgroundColor: 'rgb(120, 144, 156)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgb(120, 144, 156)'
                            }, {
                                label: 'Top 5% Benchmark',
                                data: [32, 32, 32, 32],
                                backgroundColor: 'rgba(96, 125, 59, 0.2)',    // Fern
                                borderColor: 'rgb(96, 125, 59)',              // Fern
                                pointBackgroundColor: 'rgb(96, 125, 59)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgb(96, 125, 59)'
                            }]
                        },
                        options: {
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    max: 35
                                }
                            }
                        }
                    });
                }

                // Cleanup function
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                    if (radarChartInstance.current) {
                        radarChartInstance.current.destroy();
                    }
                };
            }, [reportData]);

            if (loading) {
                return (
                    <div className="min-h-screen bg-mist flex items-center justify-center">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-spruce"></div>
                            <p className="mt-4 font-manrope text-storm-gray">Loading your report...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen bg-mist flex items-center justify-center">
                        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md">
                            <div className="text-signal-red text-5xl mb-4">‚ö†Ô∏è</div>
                            <h2 className="text-2xl font-bebas text-storm-gray mb-2 tracking-wide">Report Not Found</h2>
                            <p className="font-manrope text-storm-gray mb-4">{error}</p>
                            <a
                                href="/"
                                className="inline-block px-6 py-2 bg-river-stone text-white font-manrope font-semibold rounded-md hover:bg-spruce transition-colors"
                            >
                                Take Assessment
                            </a>
                        </div>
                    </div>
                );
            }

            // Identify top gaps
            const gaps = [
                { name: 'Transaction Oversight', score: reportData.scores.transactionOversight || 0, max: 35 },
                { name: 'Knowledge Management', score: reportData.scores.knowledgeManagement || 0, max: 35 },
                { name: 'Client Experience', score: reportData.scores.clientExperience || 0, max: 35 },
                { name: 'Risk Management', score: reportData.scores.riskManagement || 0, max: 35 }
            ].sort((a, b) => (a.score/a.max) - (b.score/b.max)).slice(0, 3);

            return (
                <div className="min-h-screen bg-mist py-8">
                    <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                        {/* Print/Share Actions */}
                        <div className="no-print mb-4 flex justify-end gap-2">
                            <button
                                onClick={() => window.print()}
                                className="px-4 py-2 bg-river-stone text-white font-manrope font-semibold rounded-md hover:bg-spruce flex items-center gap-2 transition-colors"
                            >
                                <span>üìÑ</span> Download PDF
                            </button>
                            <button
                                onClick={() => {
                                    navigator.clipboard.writeText(window.location.href);
                                    alert('Report link copied to clipboard!');
                                }}
                                className="px-4 py-2 bg-storm-gray text-white font-manrope font-semibold rounded-md hover:bg-spruce flex items-center gap-2 transition-colors"
                            >
                                <span>üîó</span> Copy Link
                            </button>
                        </div>

                        {/* Report Header */}
                        <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                            <div className="text-center mb-8">
                                <h1 className="text-4xl font-bebas text-spruce mb-2 tracking-wide">
                                    Brokerage Intelligence Report
                                </h1>
                                <p className="text-xl font-manrope font-semibold text-storm-gray">
                                    {reportData.companyInfo?.company_name || 'Your Brokerage'}
                                </p>
                                <p className="text-sm font-manrope text-storm-gray/70 mt-2">
                                    Generated: {new Date(reportData.timestamp).toLocaleDateString()}
                                </p>
                            </div>

                            {/* Overall Score Section */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                <div className="text-center">
                                    <h2 className="text-2xl font-manrope font-bold text-storm-gray mb-4">Overall Score</h2>
                                    <div className="relative inline-block">
                                        <canvas ref={chartRef} width="250" height="150"></canvas>
                                        <div className="absolute inset-0 flex items-center justify-center mt-8">
                                            <div>
                                                <div className="text-5xl font-jetbrains font-bold text-spruce">{reportData.scores.overall}</div>
                                                <div className="text-sm font-manrope text-storm-gray">out of 100</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className={`mt-4 inline-block px-4 py-2 rounded-full text-white font-manrope font-semibold ${
                                        reportData.scores.riskLevel === 'LOW' ? 'bg-fern' :
                                        reportData.scores.riskLevel === 'MODERATE' ? 'bg-amber' :
                                        reportData.scores.riskLevel === 'HIGH' ? 'bg-amber' : 'bg-signal-red'
                                    }`}>
                                        Risk Level: {reportData.scores.riskLevel}
                                    </div>
                                </div>

                                <div>
                                    <h2 className="text-2xl font-manrope font-bold text-storm-gray mb-4">Performance Breakdown</h2>
                                    <canvas ref={radarChartRef} width="300" height="300"></canvas>
                                </div>
                            </div>
                        </div>

                        {/* Brief Deficiency Teaser (not full details) */}
                        <div className="bg-white rounded-lg shadow-lg p-8 mb-6 border-2 border-signal-red">
                            <div className="text-center">
                                <div className="text-5xl mb-4">‚ö†Ô∏è</div>
                                <h2 className="text-3xl font-bebas text-signal-red mb-4 tracking-wide">
                                    We Identified {gaps.length} Critical Operational Gaps
                                </h2>
                                <p className="text-xl font-manrope text-storm-gray mb-2">
                                    These inefficiencies are costing your brokerage an estimated{' '}
                                    <span className="font-bold text-signal-red font-jetbrains">
                                        ${reportData.estimatedSavings ? reportData.estimatedSavings.toLocaleString() : '50,000'}+
                                    </span>{' '}
                                    per year in wasted time, missed deals, and liability exposure.
                                </p>
                                <p className="text-lg font-manrope text-storm-gray/80">
                                    Your complete report reveals exactly what's causing these gaps and how top brokerages have eliminated them.
                                </p>
                            </div>
                        </div>

                        {/* PROMINENT EMAIL CAPTURE - Now Position 3! */}
                        {!reportData.email ? (
                            <div className="bg-gradient-to-br from-spruce to-storm-gray rounded-lg shadow-2xl p-10 mb-6 text-white">
                                <div className="text-center max-w-4xl mx-auto">
                                    <h2 className="text-4xl md:text-5xl font-bebas mb-4 tracking-wide leading-tight">
                                        Want to See Your Full Report and How Top Brokerages Are Saving $50,000+/Year Using Technology?
                                    </h2>
                                    <p className="text-xl font-manrope mb-8 text-white/90">
                                        Discover the exact systems and capabilities your brokerage can integrate within the next 30-90 days to eliminate inefficiencies and scale profitably.
                                    </p>

                                    {/* Value Props */}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-left">
                                        <div className="bg-white/10 backdrop-blur rounded-lg p-5 border border-white/20">
                                            <div className="text-3xl mb-3">üéØ</div>
                                            <h3 className="font-bold text-lg mb-2">Detailed Gap Analysis</h3>
                                            <p className="text-sm text-white/80">See exactly what's broken, why it matters, and the hidden costs</p>
                                        </div>
                                        <div className="bg-white/10 backdrop-blur rounded-lg p-5 border border-white/20">
                                            <div className="text-3xl mb-3">üó∫Ô∏è</div>
                                            <h3 className="font-bold text-lg mb-2">30-90 Day Roadmap</h3>
                                            <p className="text-sm text-white/80">Prioritized action plan with quick wins and transformational changes</p>
                                        </div>
                                        <div className="bg-white/10 backdrop-blur rounded-lg p-5 border border-white/20">
                                            <div className="text-3xl mb-3">üí∞</div>
                                            <h3 className="font-bold text-lg mb-2">ROI Projections</h3>
                                            <p className="text-sm text-white/80">Quantified savings based on your brokerage's actual operations</p>
                                        </div>
                                    </div>

                                    {/* Email Form */}
                                    <form onSubmit={handleEmailSubmit} className="max-w-2xl mx-auto">
                                        <div className="bg-white rounded-lg p-2 shadow-xl flex flex-col sm:flex-row gap-2">
                                            <input
                                                type="email"
                                                value={email}
                                                onChange={(e) => setEmail(e.target.value)}
                                                placeholder="Enter your work email to unlock your full report"
                                                required
                                                disabled={emailSubmitting}
                                                className="flex-1 px-6 py-4 border-0 rounded-md focus:outline-none focus:ring-2 focus:ring-spruce font-manrope text-lg text-storm-gray disabled:opacity-50"
                                            />
                                            <button
                                                type="submit"
                                                disabled={emailSubmitting}
                                                className="px-8 py-4 bg-signal-red text-white font-manrope font-bold rounded-md hover:bg-signal-red/90 transition-colors text-lg whitespace-nowrap disabled:opacity-50 shadow-lg"
                                            >
                                                {emailSubmitting ? 'Unlocking...' : 'Get My Full Report ‚Üí'}
                                            </button>
                                        </div>
                                    </form>

                                    {/* Trust Indicators */}
                                    <div className="mt-6 flex flex-wrap items-center justify-center gap-6 text-sm text-white/80">
                                        <div className="flex items-center gap-2">
                                            <span>‚úì</span>
                                            <span>Instant access (no wait)</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span>‚úì</span>
                                            <span>No credit card required</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span>‚úì</span>
                                            <span>Based on 1,000+ assessments</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span>üîí</span>
                                            <span>Your data is 100% secure</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : null}

                        {/* Brokerage Rank - Now BELOW Email Capture */}
                        <div className="bg-white rounded-lg shadow-lg p-8 mb-6 border-2 border-spruce">
                            <h3 className="text-2xl font-bebas text-spruce mb-6 tracking-wide text-center">How You Compare to Other Brokerages</h3>

                            <div className="max-w-3xl mx-auto">
                                {/* Percentile Display */}
                                <div className="text-center mb-6">
                                    <div className="text-5xl font-jetbrains font-bold text-spruce mb-2">
                                        {reportData.scores.percentile}
                                    </div>
                                    <p className="text-lg font-manrope text-storm-gray">
                                        Your brokerage ranks in the <span className="font-bold">{reportData.scores.percentile}</span> of all brokerages assessed
                                    </p>
                                </div>

                                {/* Visual Progress Bar */}
                                <div className="mb-8">
                                    <div className="relative h-12 bg-gradient-to-r from-signal-red via-amber to-fern rounded-full overflow-hidden shadow-inner">
                                        <div
                                            className="absolute top-0 left-0 h-full flex items-center justify-center"
                                            style={{
                                                left: `${reportData.scores.overall}%`,
                                                transform: 'translateX(-50%)'
                                            }}
                                        >
                                            <div className="bg-white border-4 border-storm-gray rounded-full w-16 h-16 flex items-center justify-center shadow-xl">
                                                <span className="font-jetbrains font-bold text-storm-gray text-sm">{reportData.scores.overall}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex justify-between mt-2 text-sm font-manrope text-storm-gray/70">
                                        <span>Bottom 50%</span>
                                        <span>Average</span>
                                        <span>Top 5%</span>
                                    </div>
                                </div>

                                {/* Category Scores */}
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="bg-mist rounded-lg p-4 text-center border-2 border-sea-glass">
                                        <div className="text-2xl font-jetbrains font-bold text-river-stone">{reportData.scores.transactionOversight || 0}/35</div>
                                        <div className="text-sm font-manrope text-storm-gray mt-1">Transaction Oversight</div>
                                    </div>
                                    <div className="bg-mist rounded-lg p-4 text-center border-2 border-sea-glass">
                                        <div className="text-2xl font-jetbrains font-bold text-river-stone">{reportData.scores.knowledgeManagement || 0}/35</div>
                                        <div className="text-sm font-manrope text-storm-gray mt-1">Knowledge Mgmt</div>
                                    </div>
                                    <div className="bg-mist rounded-lg p-4 text-center border-2 border-sea-glass">
                                        <div className="text-2xl font-jetbrains font-bold text-river-stone">{reportData.scores.clientExperience || 0}/35</div>
                                        <div className="text-sm font-manrope text-storm-gray mt-1">Client Experience</div>
                                    </div>
                                    <div className="bg-mist rounded-lg p-4 text-center border-2 border-sea-glass">
                                        <div className="text-2xl font-jetbrains font-bold text-river-stone">{reportData.scores.riskManagement || 0}/35</div>
                                        <div className="text-sm font-manrope text-storm-gray mt-1">Risk Management</div>
                                    </div>
                                </div>

                                {/* Company Info */}
                                <div className="mt-6 bg-spruce/10 rounded-lg p-6 border-2 border-spruce">
                                    <h4 className="text-lg font-manrope font-bold text-spruce mb-3 text-center">Your Brokerage Profile</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="text-center">
                                            <div className="text-sm font-manrope text-storm-gray/70">Agents</div>
                                            <div className="text-lg font-jetbrains font-semibold text-storm-gray">{reportData.companyInfo?.agent_count || 'N/A'}</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-sm font-manrope text-storm-gray/70">Monthly Transactions</div>
                                            <div className="text-lg font-jetbrains font-semibold text-storm-gray">{reportData.companyInfo?.monthly_deals || 'N/A'}</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-sm font-manrope text-storm-gray/70">Market</div>
                                            <div className="text-lg font-manrope font-semibold text-storm-gray">{reportData.companyInfo?.location || 'N/A'}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* AI-Powered Analysis Section - GATED behind email */}
                        {reportData.email && (
                            <div className="bg-white rounded-lg shadow-lg p-8 mb-6 border-2 border-spruce">
                                <div className="flex items-center gap-3 mb-6">
                                    <div className="text-3xl">ü§ñ</div>
                                    <h2 className="text-2xl font-bebas text-spruce tracking-wide">AI-Powered Intelligence Analysis</h2>
                                </div>

                                {aiLoading ? (
                                    <div className="flex items-center justify-center py-12">
                                        <div className="text-center">
                                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-spruce mb-4"></div>
                                            <p className="font-manrope text-storm-gray">Our AI is analyzing your assessment...</p>
                                            <p className="font-manrope text-sm text-storm-gray/70 mt-2">This usually takes 10-15 seconds</p>
                                        </div>
                                    </div>
                                ) : aiSummary ? (
                                    <div className="prose max-w-none">
                                        {aiSummary.split('\n\n').map((paragraph, index) => (
                                            <p key={index} className="font-manrope text-storm-gray mb-4 leading-relaxed">
                                                {paragraph}
                                            </p>
                                        ))}

                                        <div className="mt-6 bg-spruce/5 border-l-4 border-spruce p-6 rounded-r-lg">
                                            <p className="font-manrope text-sm text-storm-gray/80 italic">
                                                üí° This analysis was generated by advanced AI trained on thousands of brokerage assessments.
                                                It identifies patterns specific to your situation that generic scoring systems miss.
                                            </p>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center py-8">
                                        <p className="font-manrope text-storm-gray">AI analysis temporarily unavailable</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Critical Gaps Detail - GATED behind email */}
                        {reportData.email && (
                            <div className="bg-white rounded-lg shadow-lg p-8 mb-6 border-2 border-signal-red">
                                <h3 className="text-2xl font-bebas text-signal-red mb-6 tracking-wide">Critical Gaps Identified</h3>
                                <ul className="space-y-4">
                                    {gaps.map((gap, index) => (
                                        <li key={index} className="flex items-start bg-signal-red/5 rounded-lg p-4 border border-signal-red/20">
                                            <span className="text-signal-red mr-3 text-2xl">‚ö†Ô∏è</span>
                                            <div className="font-manrope text-storm-gray flex-1">
                                                <div className="font-semibold text-lg mb-1">{gap.name}</div>
                                                <div className="flex items-center gap-3 text-sm">
                                                    <span className="font-jetbrains">Scoring {gap.score}/{gap.max}</span>
                                                    <span className="text-storm-gray/70">({Math.round((gap.score/gap.max)*100)}% of best practices)</span>
                                                </div>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}


                        {/* Full AI Analysis (Email Gated) or Static Content */}
                        {reportData.email && fullAnalysis ? (
                            <div className="bg-white rounded-lg shadow-lg p-8 mb-6 print-break">
                                <div className="flex items-center gap-3 mb-6">
                                    <div className="text-3xl">üéØ</div>
                                    <h2 className="text-2xl font-bebas text-spruce tracking-wide">Your Complete Intelligence Analysis</h2>
                                </div>

                                {fullAnalysisLoading ? (
                                    <div className="flex items-center justify-center py-12">
                                        <div className="text-center">
                                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-spruce mb-4"></div>
                                            <p className="font-manrope text-storm-gray">Loading your full analysis...</p>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-8">
                                        {/* Gap Analysis */}
                                        {fullAnalysis.gapAnalysis && fullAnalysis.gapAnalysis.length > 0 && (
                                            <div>
                                                <h3 className="text-xl font-bold text-storm-gray mb-4 font-manrope">Critical Operational Gaps</h3>
                                                <div className="space-y-4">
                                                    {fullAnalysis.gapAnalysis.map((gap, index) => (
                                                        <div key={index} className={`border-2 rounded-lg p-5 ${
                                                            gap.severity === 'CRITICAL' ? 'bg-signal-red/5 border-signal-red' :
                                                            gap.severity === 'HIGH' ? 'bg-amber/5 border-amber' :
                                                            'bg-river-stone/5 border-river-stone'
                                                        }`}>
                                                            <div className="flex items-start gap-3">
                                                                <div className="text-2xl">
                                                                    {gap.severity === 'CRITICAL' ? 'üö®' : gap.severity === 'HIGH' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                                                                </div>
                                                                <div className="flex-1">
                                                                    <div className="flex items-center justify-between mb-2">
                                                                        <h4 className="text-lg font-bold text-storm-gray font-manrope">{gap.category}</h4>
                                                                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                                                            gap.severity === 'CRITICAL' ? 'bg-signal-red text-white' :
                                                                            gap.severity === 'HIGH' ? 'bg-amber text-white' :
                                                                            'bg-river-stone text-white'
                                                                        }`}>
                                                                            {gap.severity}
                                                                        </span>
                                                                    </div>
                                                                    <p className="text-storm-gray font-semibold mb-3 font-manrope">{gap.issue}</p>
                                                                    {gap.evidence && (
                                                                        <div className="bg-white rounded p-3 mb-3 border border-sea-glass">
                                                                            <div className="text-sm text-storm-gray/70 mb-1 font-manrope">Evidence from your assessment:</div>
                                                                            <div className="text-sm italic text-storm-gray font-manrope">"{gap.evidence}"</div>
                                                                        </div>
                                                                    )}
                                                                    {gap.businessImpact && (
                                                                        <div className="grid grid-cols-3 gap-3 text-sm mb-3">
                                                                            {gap.businessImpact.timeWasted && (
                                                                                <div>
                                                                                    <div className="font-semibold text-storm-gray font-manrope">Time Wasted</div>
                                                                                    <div className="text-signal-red font-jetbrains">{gap.businessImpact.timeWasted}</div>
                                                                                </div>
                                                                            )}
                                                                            {gap.businessImpact.financialCost && (
                                                                                <div>
                                                                                    <div className="font-semibold text-storm-gray font-manrope">Financial Cost</div>
                                                                                    <div className="text-signal-red font-jetbrains">{gap.businessImpact.financialCost}</div>
                                                                                </div>
                                                                            )}
                                                                            {gap.businessImpact.riskCreated && (
                                                                                <div>
                                                                                    <div className="font-semibold text-storm-gray font-manrope">Risk Created</div>
                                                                                    <div className="text-signal-red font-manrope text-sm">{gap.businessImpact.riskCreated}</div>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    )}
                                                                    {gap.industryBestPractice && (
                                                                        <div className="p-3 bg-spruce/5 border-l-4 border-spruce rounded-r">
                                                                            <div className="text-sm font-semibold text-spruce mb-1 font-manrope">How Top Brokerages Handle This:</div>
                                                                            <div className="text-sm text-storm-gray font-manrope">{gap.industryBestPractice}</div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        {/* Financial Impact */}
                                        {fullAnalysis.financialImpact && (
                                            <div className="bg-mist rounded-lg p-6">
                                                <h3 className="text-xl font-bold text-storm-gray mb-4 font-manrope">Financial Impact Analysis</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                    {fullAnalysis.financialImpact.currentStateCosts && (
                                                        <div className="bg-signal-red/5 border-2 border-signal-red rounded-lg p-5">
                                                            <h4 className="text-lg font-bold text-signal-red mb-3 font-manrope">Current State Costs</h4>
                                                            <div className="space-y-2">
                                                                {Object.entries(fullAnalysis.financialImpact.currentStateCosts).map(([key, value]) => (
                                                                    key !== 'totalAnnual' && value && (
                                                                        <div key={key} className="flex justify-between text-sm">
                                                                            <span className="text-storm-gray font-manrope capitalize">{key.replace(/([A-Z])/g, ' $1').trim()}:</span>
                                                                            <span className="font-jetbrains text-signal-red font-semibold">{value}</span>
                                                                        </div>
                                                                    )
                                                                ))}
                                                                {fullAnalysis.financialImpact.currentStateCosts.totalAnnual && (
                                                                    <div className="border-t-2 border-signal-red/20 pt-3 mt-3">
                                                                        <div className="flex justify-between">
                                                                            <span className="font-bold text-storm-gray font-manrope">Total Annual Cost:</span>
                                                                            <span className="text-xl font-jetbrains font-bold text-signal-red">
                                                                                {fullAnalysis.financialImpact.currentStateCosts.totalAnnual}
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    )}

                                                    {fullAnalysis.financialImpact.projectedSavings && (
                                                        <div className="bg-fern/5 border-2 border-fern rounded-lg p-5">
                                                            <h4 className="text-lg font-bold text-fern mb-3 font-manrope">Projected Savings</h4>
                                                            <div className="space-y-2">
                                                                {Object.entries(fullAnalysis.financialImpact.projectedSavings).map(([key, value]) => (
                                                                    key !== 'totalAnnual' && key !== 'roi' && value && (
                                                                        <div key={key} className="flex justify-between text-sm">
                                                                            <span className="text-storm-gray font-manrope capitalize">{key.replace(/([A-Z])/g, ' $1').trim()}:</span>
                                                                            <span className="font-jetbrains text-fern font-semibold">{value}</span>
                                                                        </div>
                                                                    )
                                                                ))}
                                                                {(fullAnalysis.financialImpact.projectedSavings.totalAnnual || fullAnalysis.financialImpact.projectedSavings.roi) && (
                                                                    <div className="border-t-2 border-fern/20 pt-3 mt-3 space-y-2">
                                                                        {fullAnalysis.financialImpact.projectedSavings.totalAnnual && (
                                                                            <div className="flex justify-between">
                                                                                <span className="font-bold text-storm-gray font-manrope">Total Annual Savings:</span>
                                                                                <span className="text-xl font-jetbrains font-bold text-fern">
                                                                                    {fullAnalysis.financialImpact.projectedSavings.totalAnnual}
                                                                                </span>
                                                                            </div>
                                                                        )}
                                                                        {fullAnalysis.financialImpact.projectedSavings.roi && (
                                                                            <div className="flex justify-between">
                                                                                <span className="font-bold text-storm-gray font-manrope">ROI:</span>
                                                                                <span className="text-lg font-jetbrains font-bold text-spruce">
                                                                                    {fullAnalysis.financialImpact.projectedSavings.roi}
                                                                                </span>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                                {fullAnalysis.financialImpact.implementationNote && (
                                                    <div className="mt-4 bg-white border-l-4 border-spruce p-4 rounded-r">
                                                        <p className="text-sm text-storm-gray font-manrope">{fullAnalysis.financialImpact.implementationNote}</p>
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        {/* Key Insight */}
                                        {fullAnalysis.keyInsight && (
                                            <div className="bg-spruce/10 border-2 border-spruce rounded-lg p-6 text-center">
                                                <div className="text-4xl mb-3">üí°</div>
                                                <h4 className="text-xl font-bold text-spruce mb-3 font-manrope">Your Key Insight</h4>
                                                <p className="text-lg text-storm-gray italic font-manrope leading-relaxed">
                                                    "{fullAnalysis.keyInsight}"
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="bg-white rounded-lg shadow-lg p-8 mb-6 print-break">
                                <h2 className="text-2xl font-bebas text-spruce mb-6 tracking-wide">What the Top 5% Do Differently</h2>

                            <div className="space-y-6">
                                <div className="border-l-4 border-spruce pl-4">
                                    <h3 className="font-manrope font-bold text-lg mb-2 text-storm-gray">Transaction Oversight</h3>
                                    <p className="font-manrope text-storm-gray">
                                        Elite brokerages use AI-powered monitoring that reviews 100% of transactions in real-time,
                                        catching issues before they become problems. They maintain less than 1% error rate compared
                                        to the industry average of 15%.
                                    </p>
                                </div>

                                <div className="border-l-4 border-spruce pl-4">
                                    <h3 className="font-manrope font-bold text-lg mb-2 text-storm-gray">Knowledge Management</h3>
                                    <p className="font-manrope text-storm-gray">
                                        Top performers capture every lesson learned and encode it into their systems. New agents
                                        reach full productivity in 6 weeks versus the 6-month industry average.
                                    </p>
                                </div>

                                <div className="border-l-4 border-spruce pl-4">
                                    <h3 className="font-manrope font-bold text-lg mb-2 text-storm-gray">Client Experience</h3>
                                    <p className="font-manrope text-storm-gray">
                                        Leading brokerages provide 24/7 transaction visibility through AI chatbots and portals,
                                        resulting in 67% more referrals from satisfied clients.
                                    </p>
                                </div>

                                <div className="border-l-4 border-spruce pl-4">
                                    <h3 className="font-manrope font-bold text-lg mb-2 text-storm-gray">Risk Management</h3>
                                    <p className="font-manrope text-storm-gray">
                                        Elite firms predict and prevent issues with AI risk scoring, reducing E&O claims by 80%
                                        and saving an average of $45,000 annually in liability costs.
                                    </p>
                                </div>
                            </div>

                            {/* Action Plan */}
                            <div className="mt-8 bg-mist rounded-lg p-6">
                                <h3 className="text-xl font-manrope font-bold text-storm-gray mb-4">Your 30-Day Quick Wins</h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="bg-white rounded p-4 border-2 border-sea-glass">
                                        <div className="font-manrope font-bold text-spruce mb-2">Week 1</div>
                                        <ul className="text-sm font-manrope text-storm-gray space-y-1">
                                            <li>‚Ä¢ Implement deadline checklist</li>
                                            <li>‚Ä¢ Create contract templates</li>
                                            <li>‚Ä¢ Set up daily huddles</li>
                                        </ul>
                                    </div>
                                    <div className="bg-white rounded p-4 border-2 border-sea-glass">
                                        <div className="font-manrope font-bold text-spruce mb-2">Week 2-3</div>
                                        <ul className="text-sm font-manrope text-storm-gray space-y-1">
                                            <li>‚Ä¢ Build knowledge library</li>
                                            <li>‚Ä¢ Launch client portal</li>
                                            <li>‚Ä¢ Train on best practices</li>
                                        </ul>
                                    </div>
                                    <div className="bg-white rounded p-4 border-2 border-sea-glass">
                                        <div className="font-manrope font-bold text-spruce mb-2">Week 4</div>
                                        <ul className="text-sm font-manrope text-storm-gray space-y-1">
                                            <li>‚Ä¢ Measure improvements</li>
                                            <li>‚Ä¢ Gather agent feedback</li>
                                            <li>‚Ä¢ Plan automation phase</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            {/* ROI Calculator */}
                            <div className="mt-8 bg-spruce/10 rounded-lg p-6 border-2 border-spruce">
                                <h3 className="text-xl font-manrope font-bold text-spruce mb-4">Potential ROI from Improvements</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p className="font-manrope text-storm-gray mb-2">Based on {reportData.companyInfo?.agent_count || 'your'} agents and {reportData.companyInfo?.monthly_deals || 'your'} monthly deals:</p>
                                        <ul className="space-y-2 font-manrope text-storm-gray">
                                            <li>‚Ä¢ Time savings: <span className="font-semibold font-jetbrains">600 hours/month</span></li>
                                            <li>‚Ä¢ Risk reduction: <span className="font-semibold font-jetbrains">$36,000/year saved</span></li>
                                            <li>‚Ä¢ Deal saves: <span className="font-semibold font-jetbrains">5 deals/month recovered</span></li>
                                        </ul>
                                    </div>
                                    <div className="bg-white rounded p-4 text-center border-2 border-sea-glass">
                                        <div className="text-3xl font-jetbrains font-bold text-fern">$58,000</div>
                                        <div className="font-manrope text-storm-gray">Monthly Value Created</div>
                                        <div className="mt-2 text-2xl font-jetbrains font-bold text-spruce">38X ROI</div>
                                        <div className="font-manrope text-storm-gray">on Technology Investment</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        )}

                        {/* CTA Section (no-print) */}
                        <div className="no-print bg-spruce rounded-lg shadow-lg p-8 text-white text-center">
                            <h3 className="text-2xl font-bebas mb-4 tracking-wide">Ready to Close These Gaps?</h3>
                            <p className="text-lg font-manrope mb-6">
                                Schedule a free 15-minute consultation to discuss your customized improvement roadmap.
                            </p>
                            <a
                                href="mailto:contact@yourdomain.com?subject=Brokerage Intelligence Consultation"
                                className="inline-block px-8 py-3 bg-river-stone text-white font-manrope font-semibold rounded-md hover:bg-white hover:text-spruce transition-colors"
                            >
                                Schedule Your Consultation
                            </a>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<ReportPage />, document.getElementById('root'));
    </script>
</body>
</html>
<!-- Build: 1762303936 - Fix data mapping -->
